name: Build FFmpeg with CUDA

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          autoconf \
          automake \
          build-essential \
          cmake \
          git-core \
          libass-dev \
          libfreetype6-dev \
          libgnutls28-dev \
          libmp3lame-dev \
          libopus-dev \
          libsdl2-dev \
          libtheora-dev \
          libtool \
          libva-dev \
          libvdpau-dev \
          libvorbis-dev \
          libxcb1-dev \
          libxcb-shm0-dev \
          libxcb-xfixes0-dev \
          meson \
          ninja-build \
          pkg-config \
          texinfo \
          wget \
          yasm \
          zlib1g-dev
        
    - name: Install NVIDIA CUDA Toolkit
      run: |
        wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-ubuntu2004.pin
        sudo mv cuda-ubuntu2004.pin /etc/apt/preferences.d/cuda-repository-pin-600
        sudo apt-key adv --fetch-keys https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/7fa2af80.pub
        sudo add-apt-repository "deb https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/ /"
        sudo apt-get update
        sudo apt-get -y install cuda-toolkit-11-6
        
    - name: Set up environment variables
      run: |
        echo "CUDA_PATH=/usr/local/cuda" >> $GITHUB_ENV
        echo "PATH=/usr/local/cuda/bin:$PATH" >> $GITHUB_ENV
        echo "LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH" >> $GITHUB_ENV
        
    - name: Clone FFmpeg source
      run: |
        git clone https://git.ffmpeg.org/ffmpeg.git
        cd ffmpeg
        git checkout release/6.0
        
    - name: Install nv-codec-headers
      run: |
        git clone https://git.videolan.org/git/ffmpeg/nv-codec-headers.git
        cd nv-codec-headers
        make
        sudo make install
        
    - name: Configure FFmpeg with CUDA and nonfree
      run: |
        cd ffmpeg
        ./configure \
          --enable-nonfree \
          --enable-gpl \
          --enable-cuda-nvcc \
          --enable-cuvid \
          --enable-nvdec \
          --enable-nvenc \
          --enable-libnpp \
          --extra-cflags=-I/usr/local/cuda/include \
          --extra-ldflags=-L/usr/local/cuda/lib64 \
          --nvccflags='-gencode arch=compute_52,code=sm_52 -O2' \
          --enable-libass \
          --enable-libfreetype \
          --enable-libmp3lame \
          --enable-libopus \
          --enable-libtheora \
          --enable-libvorbis \
          --enable-libx264 \
          --enable-libx265 \
          --enable-openssl \
          --enable-shared \
          --disable-static \
          --prefix=/tmp/ffmpeg-build
        
    - name: Build FFmpeg
      run: |
        cd ffmpeg
        make -j$(nproc)
        make install
        
    - name: Package build artifacts
      run: |
        mkdir -p ffmpeg-cuda-build
        cp -r /tmp/ffmpeg-build/bin/* ffmpeg-cuda-build/
        cp -r /tmp/ffmpeg-build/lib/* ffmpeg-cuda-build/
        tar -czf ffmpeg-cuda-linux-x64.tar.gz ffmpeg-cuda-build
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ffmpeg-cuda-build
        path: ffmpeg-cuda-linux-x64.tar.gz
        
    - name: Create Release (on push to main)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        files: ffmpeg-cuda-linux-x64.tar.gz
        token: ${{ secrets.GITHUB_TOKEN }}